{{- $baseName := randAlphaNum 4 | lower }}
{{- $generatedName := printf "gloo-%s" $baseName }}
{{- $name := .Values.metadata.name | default $generatedName }}
{{- $namespace := .Values.metadata.namespace | default "gloo-system" }}
{{- $hostnames := .Values.spec.hostnames | default (list (printf "%s.glootest.com" $name)) }}
{{- $prefixPath := index .Values.metadata.labels "prefixPath" | default $name }}
{{- $routeOptionName := printf "%s-route-policies" $name }}  # Default RouteOption name
{{- $jwtDisabled := .Values.spec.routeOption.jwt.disable | default false }}  # Configurable JWT disable value
---
# HTTPRoute resource
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: {{ $name }}
  namespace: {{ $namespace }}
  labels:
    example: {{ .Values.metadata.labels.example | default "sample-app-route" }}
    gateway: {{ .Values.metadata.labels.gateway | default "https" }}
spec:
  hostnames:
{{- range $hostnames }}
    - {{ . }}
{{- end }}
  parentRefs:
    - name: "https"
      namespace: "gloo-system"
  rules:
{{- range .Values.spec.rules }}
    - backendRefs:
{{- range .backendRefs }}
        - group: {{ .group | default "gloo.solo.io" }}
          kind: {{ .kind | default "Upstream" }}
          name: {{ .name | default $name }}
{{- end }}
      matches:
{{- range .matches }}
        - path:
            type: {{ .path.type | default "PathPrefix" }}
            value: {{ .path.value | default "/" }}
{{- end }}
      filters:
        - type: ExtensionRef
          extensionRef:
            group: gateway.solo.io
            kind: RouteOption
            name: {{ .routeOptionName | default $routeOptionName }}  # Default RouteOption name
{{- end }}
---
# RouteOption resource
apiVersion: gateway.solo.io/v1
kind: RouteOption
metadata:
  name: {{ $routeOptionName }}
  namespace: {{ $namespace }}
spec:
  options:
    jwt:
      disable: {{ $jwtDisabled }}  # Configurable true/false
